---
title: "Degrees_Bookworm"
output: html_document
---

```{r}
source("read_cips.R")

characteristics = read_csv("hd2015.csv")
cips = return_cips()
data = return_data()
```



```{r}
data = data %>%
  filter(CIPCODE != "99.0000", CIPCODE != "99") %>%
  mutate(AWLEVEL=as.numeric(AWLEVEL),MAJORNUM=as.numeric(MAJORNUM))

#data %>% filter(degrees > 1000, AWLEVEL==5) %>% arrange(-degrees)
#characteristics %>% filter(UNITID=="433387") %>% glimpse
```

```{r}
undergrad_majors = data %>% filter(AWLEVEL==5, MAJORNUM==1)

undergrad_majors %>% group_by(year) %>% tally(degrees) %>% ggplot() + geom_line(aes(x=year, y = n)) + scale_y_log10()

undergrad_majors %>% group_by(year, race) %>% tally(degrees) %>% ggplot() + geom_line(aes(x=year, y = n, color = race)) + scale_y_log10()


into_major_nums = . %>% 
  group_by(year,AWLEVEL,MAJORNUM,add = T) %>% 
  filter(!is.na(degrees)) %>%
  mutate(year_total=sum(degrees)) %>% 
  group_by(year,CIPCODE,year_total,AWLEVEL,MAJORNUM,add=T) %>%
  summarize(degrees = sum(degrees))
  
```

Understanding by institutional control

```{r}

majors_with_control = data %>% mutate(AWLEVEL=as.numeric(AWLEVEL),MAJORNUM=as.numeric(MAJORNUM)) %>% 
  filter(AWLEVEL==5,MAJORNUM==1) %>% 
  left_join(characteristics %>% select(UNITID,CONTROL)) %>%
  mutate(subcip = gsub("\\..*","",CIPCODE)) %>% 
  filter(subcip!="99") %>%
  group_by(year,AWLEVEL,MAJORNUM,CONTROL) %>% 
  mutate(year_total=sum(degrees)) %>% 
  group_by(year,CIPCODE,subcip,year_total,AWLEVEL,MAJORNUM,CONTROL) %>%
  summarize(degrees = sum(degrees))


control = data %>% 
  mutate(AWLEVEL = as.numeric(AWLEVEL)) %>%
  filter(AWLEVEL==5,MAJORNUM==1) %>%
  left_join(characteristics %>% select(UNITID,CONTROL)) %>%
  group_by(CONTROL,year) %>%
  summarize(count=n()) %>% ungroup %>%
  mutate(CONTROL=factor(CONTROL,labels=c("public","not-for-profit private","for profit private", "NA"), exclude = NULL)) %>%
  group_by(year) %>% mutate(percent = count/sum(count)) %>% ungroup %>%
  arrange(-year)

ggplot(control) + geom_line(aes(x=year,y=percent,color=CONTROL))
  
```


```{r, fig.width=4,fig.height=4}

library(ggrepel)


plottable = undergrad_majors %>% 
  into_major_nums %>% 
  left_join(cips,by=c("CIPCODE"="CIPCode"))

this_plot = plottable %>% filter(year >= 1985) %>%
    group_by(year,General,Type) %>%
    filter(General %in% c("Humanities")) %>% 
    filter(Type %in% c("English","History","Languages and Literature","Philosophy","Area Studies")) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1])
  
this_plot %>% ggplot(aes(x=year,y=percent,fill=Type,label=Type,color=Type)) +
    geom_line() + 
    scale_y_continuous(labels=scales::percent) + 
#    facet_wrap(~Type,scales="free_y") + 
   theme(legend.position="none") + 
    labs(title="The big humanities majors\ncontinue to decline",subtitle="As percentage of all BAs; all US institutions",
         caption = "IPEDS data (preliminary for 2017)\nChart by Ben Schmidt, 2018") + geom_text_repel(data=this_plot %>% filter(year==2005))

this_plot %>%
  group_by(Type) %>%
  mutate(degrees = degrees/max(degrees)) %>% 
  ggplot(aes(x=year,y=degrees,fill=Type,label=Type,color=Type)) +
    geom_line() + 
    scale_y_continuous("Percent change from maximum number of BAs", labels=scales::percent) + 
#    facet_wrap(~Type,scales="free_y") + 
   theme(legend.position="none") + 
    labs(title="The big humanities majors\ncontinue to decline",subtitle="Raw number of BAs; all US institutions",
         caption = "IPEDS data (preliminary for 2017)\nChart by Ben Schmidt, 2018") + geom_text_repel(data=this_plot %>% group_by(Type) %>%
  mutate(degrees = degrees/max(degrees)) %>% filter(year==2017))

```
Why is English *so* bad in 2010? The answer: CIPS changed the reporting from "Speech and rhetorical studies" to "rhetoric and composition," and that lost a few thousand degrees in a batch.

``` {r}
engq = plottable %>% filter(year > 2008, year < 2011) %>% filter(Type=="English")
engq %>% ungroup %>% mutate(lab = paste(CIP2010, CIPTitle)) %>% select(year, degrees, lab) %>% spread(year, degrees) %>% mutate(change = `2009` - `2010`) %>% arrange(-change)

```


```{r}
undergrad_majors = data %>% filter(AWLEVEL==5, MAJORNUM==1) %>% group_by(MAJORNUM)
into_major_nums = . %>% 
  group_by(year,AWLEVEL,add = T) %>% 
  filter(!is.na(degrees)) %>%
  mutate(year_total=sum(degrees)) %>% 
  group_by(year,CIPCODE,year_total,AWLEVEL,MAJORNUM, add=T) %>%
  summarize(degrees = sum(degrees))

with_num = data %>% ungroup %>% filter(AWLEVEL==5, MAJORNUM==1) %>% into_major_nums

with_num %>% mutate(percent = degrees/year_total) %>% left_join(cips,by=c("CIPCODE"="CIPCode")) %>%
  group_by(Type, year, General, MAJORNUM) %>% summarize(percent = sum(percent)) %>% filter(General=="Humanities") %>% ggplot() + geom_line(aes(x=year,y=percent,color=Type, lty=factor(MAJORNUM)))
```

```{r}
with_num = data %>% ungroup %>% filter(AWLEVEL==5, MAJORNUM==1) %>% into_major_nums %>% left_join(cips,by=c("CIPCODE"="CIPCode"))

with_num  %>% group_by(year, CIPCODE,CIPTitle) %>% summarize(degrees=sum(degrees)) %>%
  group_by(CIPCODE, CIPTitle) %>%
  summarize(min = max(year[degrees < degrees[year==2017]])) %>% arrange(min) %>% filter(min > 0)

```

Other fields?



```{r fig.width=8, fig.height=7}
with_num = data %>% filter (year > 1997) %>% ungroup %>% filter(AWLEVEL==5, MAJORNUM==1) %>% into_major_nums

this_plot = with_num %>% mutate(percent = degrees/year_total) %>% left_join(cips,by=c("CIPCODE"="CIPCode")) %>%
  group_by(Type, General, MAJORNUM, year) %>% 
  summarize(percent = sum(percent)) %>% filter(max(percent) > .005)
  
this_plot %>% 
  ggplot() + 
  aes(x=year,y=percent, color=Type, label = Type) +
  geom_line() + 
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~General, scales="free_y") + theme(legend.position="none") + 
    labs(title="Changes in Majors since 1997",subtitle="As share of BAs; all US institutions",
         caption = "IPEDS data (preliminary for 2017)\nChart by Ben Schmidt, 2018") + 
  geom_text_repel(data=this_plot %>% filter(year==2015))

```

Political Science and economics are also in trouble.

```{r fig.width=5, fig.height=8}

this_plot = with_num %>% mutate(percent = degrees/year_total) %>% left_join(cips,by=c("CIPCODE"="CIPCode")) %>%
  group_by(Type, MAJORNUM, year, General) %>% 
  summarize(percent = sum(percent)) %>%
  group_by(Type) %>%
  filter(General %in% c("Social Science", "Humanities"), max(percent) > .01, Type != "General") %>%
  group_by(Type) %>% mutate(percent=percent/(percent[year==2008]))

this_plot %>% 
  ggplot() + 
  aes(x=year,y=percent, color=Type, label = Type) +
  geom_line() + 
  scale_y_continuous(labels = scales::percent) +
 # facet_wrap(~General, scales="free_y") + 
  theme(legend.position="none") + 
    labs(title="Changes in Major share since 1997",subtitle="As share of BA, relative to 2008 numbers; all US institutions.",
         caption = "IPEDS data (preliminary for 2017)\nChart by Ben Schmidt, 2018.") + 
  geom_text_repel(data=this_plot %>% filter(year==2017))
```


```{r}

this_plot = with_num %>% mutate(percent = degrees/year_total) %>% left_join(cips,by=c("CIPCODE"="CIPCode")) %>%
  group_by(General, MAJORNUM, year) %>% 
  summarize(percent = sum(percent)) %>% filter(max(percent) > .005)

this_plot = with_num %>% mutate(percent = degrees/year_total) %>% left_join(cips,by=c("CIPCODE"="CIPCode")) %>%
  group_by(General, MAJORNUM, year) %>% 
  summarize(percent = sum(percent)) %>% filter(max(percent) > .005)

```

What's the universe of Humanities Degrees

```{r}

library(forcats)

this_plot = data %>% filter(year==2017, AWLEVEL==5) %>% mutate(year_total = n()) %>% 
  left_join(cips, by=c("CIPCODE"="CIPCode")) %>%
  filter(General=="Humanities") %>%
  mutate(label = paste0(CIPCODE, CIPTitle)) %>% 
  mutate(label = forcats::fct_lump(label, n = 50)) %>%
  group_by(label, Type, year_total) %>% summarize(count=n()) %>% 
  ungroup %>%
  mutate(label = fct_reorder(label, count)) 

this_plot %>%
  ggplot() + geom_point(aes(x=reorder(label, count), y = count, color=Type)) + coord_flip() + scale_y_log10()

this_plot %>% mutate(bin = as.integer(label) < 4) %>% group_by(bin) %>% summarize(n = sum(count))
```

```{r}
plottable %>% distinct(year, year_total) %>% ggplot() + geom_line(aes(x=year, y = year_total))
pl = plottable %>% group_by(CIPCODE, CIPTitle, year) %>% summarize(percent = sum(degrees)/year_total[1]) %>% mutate(dropping = percent  - lag(percent,1) < 0) %>% select(year, dropping, CIPTitle, CIPCODE, percent) %>% filter(!is.na(dropping)) %>% filter(grepl("History, General.", CIPTitle))

streaks = function(pl) {
  lengths = rle(pl$dropping)
  ends = cumsum(lengths$lengths)
  starts = cumsum(c(1, lengths$lengths[1:(length(ends) - 1)]))
  labs = paste(pl$year[starts],"-", pl$year[ends])
  change = (pl$percent[ends] - pl$percent[starts])/pl$percent[starts] * 100
  data_frame(dropping = lengths$values, length = lengths$lengths, label = labs, change = change)
}
streaks(pl)
pl = plottable %>% group_by(CIPCODE, CIPTitle, year) %>% summarize(percent = sum(degrees)/year_total[1]) %>%
  mutate(dropping = percent  - lag(percent,1) < 0) %>% filter(!is.na(dropping))

dropping_summaries = pl %>% do(streaks(.)) %>% arrange(-length)
dropping_summaries %>% filter(dropping == FALSE) %>% arrange(-length) %>% head(10) %>% select(CIPCODE, CIPTitle, label, length, change)

plottable %>% filter(CIPCODE %in% c("31.0505", "54.0101", "45.0801")) %>% mutate(percent = degrees/year_total) %>% ggplot() + geom_line(aes(x=year,y=percent, color = CIPTitle))
```

```{r}
this_plot %>% arrange(year) %>% group_by(Type) %>% mutate(change = percent/lag(percent, 1) - 1) %>% 
  ggplot() + geom_point(aes(x=year,y=change, color=Type))
```

```{r}

this_plot = plottable %>% filter(year >= 1980) %>%
    group_by(year,General,Type) %>%
    filter(
      Type %in% c("English","History","Philosophy","Area Studies", "Languages and Literature")
      ) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1])



this_plot %>% ggplot() + geom_line(aes(x=year,y=percent, color=Type))

```

```{r fig.width=4,fig.height=4}
tp2 = this_plot %>% 
  group_by(Type) %>% 
  mutate(peak = max(percent)) %>% 
  mutate(relative = percent/peak) 

tp2 %>%
  ggplot(aes(x=year,y=relative-1,fill=Type,label=Type,color=Type)) +
    geom_line() + 
    scale_y_continuous("Percentage decline from peak", labels=scales::percent, limits = c(-.5, 0)) + 
   theme(legend.position="none") + 
    labs(title="Humanities majors continue to fall",subtitle="Decline from peak share of degrees since 1997\nall US institutions",
         caption = "IPEDS data (preliminary for 2016/2017)\nChart by Ben Schmidt, 2018") + geom_text_repel(data=tp2 %>% filter(year==2017)) 
```
```{r fig.width=4,fig.height=4}
tp2 = this_plot %>% 
  group_by(Type) %>% 
  mutate(peak = max(percent)) %>% 
  mutate(relative = percent/peak) 

tp2 %>%
  ggplot(aes(x=year,y=relative-1,fill=Type,label=Type,color=Type)) +
    geom_line() + 
    scale_y_continuous("Percentage decline from peak", labels=scales::percent, limits = c(-.5, 0)) + 
   theme(legend.position="none") + 
    labs(title="Humanities minors are also falling",subtitle="Decline from peak share of minors since 1997\nall US institutions",
         caption = "IPEDS data (preliminary for 2017)\nChart by Ben Schmidt, 2018") + geom_text_repel(data=tp2 %>% filter(year==2017)) 
```


```{r}
plottable %>% filter(year > 2000) %>%
    group_by(year,General,Type) %>%
    filter(General %in% c("Humanities")) %>% 
    filter(Type %in% c("English","History","Languages and Literature","Philosophy","Area Studies")) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1]) %>%
    group_by(year) %>% summarize(percent = sum(percent),degrees=sum(degrees)) %>% filter(year > 2008)

```

```{r fig.height=6,fig.width=9}
change = plottable %>% group_by(year,Type,General) %>% summarize(degrees=sum(degrees,na.rm=T)) %>% group_by(Type,General) %>%
  summarize(nineties = sum(degrees[year >= 1995 & year <= 2000],na.rm=T), recent = sum(degrees[year >= 2012 & year <= 2013]), now = sum(degrees[year >= 2016]))

grid_change = change %>% ungroup %>% filter(nineties > 0, nineties * 3 > recent) %>% 
  mutate(n_share = nineties/sum(nineties), r_share = recent/sum(recent),now_share = now/sum(now),
         recent_change = now_share/r_share,
         long_change = now_share/n_share,
         total = sum(now_share)
         )

grid_change %>% filter(Type!="General") %>% ggplot() + geom_text_repel(aes(x=recent_change,y=long_change,label=Type,color=General,size=now_share)) + 
  scale_x_log10("Level compared to 2012-2013",breaks = c(.5,.7,.8,.9,1,1.2,1.5,2),labels=scales::percent) + scale_y_log10("Level compared to 1995-2000",breaks = c(.5,.7,.8,.9,1,1.2,1.5,2),labels=scales::percent) + scale_size_continuous(trans="sqrt") +
  annotate("text",alpha=.3,label="Increasing",size=16,x=1.3,y=2.2) + 
  annotate("text",alpha=.3,label="Decreasing\nafter\nlong-term\nincrease",size=12,x=.8,y=2.2) +
  annotate("text",alpha=.3,label="Decreasing",size=16,x=.75,y=.8) + 
  annotate("text",alpha=.3,label="Increasing\nafter\nlong-term\ndecrease",size=12,x=1.2,y=.6) +
  geom_hline(yintercept=1,size=3,lty=2,alpha=.4) + 
  geom_vline(xintercept=1,size=3,lty=2,alpha=.4)

```

```{r}
0.02874805 / 0.03870427
0.02673785 / 0.03617526
```

```{r}

plottable2 = data %>% group_by(gender,year,control) %>% into_major_nums %>% inner_join(cips,by=c("CIPCODE"="CIPCode")) %>% ungroup
majors_with_control %>% sample_n(10)
plottable2 %>% group_by(gender,General,Type,year) %>% filter(year >= 2001) %>%
#    filter(General %in% c("Humanities")) %>% 
    filter(Type %in% c("English","Communications")) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1]) %>% 
    mutate(reference = percent[year==2008][1],scaled = percent/reference*100) %>%
    ggplot() +
    aes(x=year,y=percent,lty=gender,col=Type) +
    geom_line() + 
    scale_y_continuous(labels=scales::percent) + 
#    facet_wrap(~control) + 
    #theme(legend.position="none") + 
    labs(title="Various majors, as percent of all US BAs")
```

```{r cars}
top30 = characteristics %>% filter(grepl("Harvard|Yale|Princeton|Dartmouth|University of Pennsylvania|Brown|University of Chicago|Stanford|Columbia University|Duke|Massachusetts Institute|University of Pennsylvania|Johns Hopkins|California Institute|Northwestern|Cornell|Rice|Notre Dame|Vanderbilt|Washington University|Georgetown|Berkeley|Southern California|Carnegie Mellon|Los Angeles|University of Virginia|Tufts|Ann Arbor|Wake Forest|Chapel Hill",INSTNM),CARNEGIE==15) %>% select(UNITID,INSTNM)

top1 = characteristics %>% filter(grepl("Yale University",INSTNM),CARNEGIE==15) %>% select(UNITID,INSTNM)

p3 = data %>% inner_join(top30) %>% 
  mutate(gender="cis") %>%
  group_by(gender) %>% 
  into_major_nums %>%
  inner_join(cips,by=c("CIPCODE"="CIPCode")) %>%
    mutate(Type = ifelse(Type %in% c("General","Humanities"), "General Humanities",Type)) %>%
    group_by(year,General,Type,gender) %>%
    filter(General %in% c("Humanities","Social Science")) %>% 
    filter(Type %in% c("English","History","Languages and Literature","Philosophy")) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1])
    #filter(sum(degrees) > 1000) %>%
  
p3
  
p3 %>% filter(year > 1997) %>%
    ggplot(aes(x=year,y=percent,fill=Type)) +
    geom_line() + 
    scale_y_continuous(labels=scales::percent) + 
    facet_wrap(~Type,scales="free_y") + 
    labs(title="Various majors, as percent of all BAs\nat the top 30 universities according to US News")# + geom_point(data=data_frame(year=2000,percent=0,Type=unique(p3$Type),alpha=0))


```


```{r}
data %>% into_major_nums %>% into_labeled %>%
    mutate(Type = ifelse(Type %in% c("General","Humanities"), "General Humanities",Type)) %>%
    group_by(year,General,Type) %>%
    filter(General %in% c("Humanities")) %>% 
    group_by(year,Type,CIPTitle) %>%
    #filter(Type %in% c("English","History","Languages and Literature","Philosophy")) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1]) %>% 
    #filter(sum(degrees) > 1000) %>%
    ggplot(aes(x=year,y=percent,fill=Type)) +
    geom_area() + 
    scale_y_continuous(labels=percent) + 
    facet_wrap(~CIPTitle,scales="free_y") + 
    theme(legend.position="none") + 
    labs(title="Various majors, as percent of all BAs\nat the top 30 universities according to US News")
```

```{r}
data %>% into_major_nums %>% into_labeled %>%
    mutate(Type = ifelse(Type %in% c("General","Humanities"), "General Humanities",Type)) %>%
    group_by(year,General,Type) %>%
    filter(General %in% c("Humanities")) %>% 
    group_by(year,Type,CIPTitle) %>%
    filter(Type %in% c("English","Communications")) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1]) %>% 
    #filter(sum(degrees) > 1000) %>%
    ggplot(aes(x=year,y=percent,fill=Type)) +
    geom_area() + 
    scale_y_continuous(labels=percent) + 
    facet_wrap(~CIPTitle,scales="free_y") + 
    theme(legend.position="none") + 
    labs(title="Various majors, as percent of all BAs\nat the top 30 universities according to US News")

```

```{r}
NEU = characteristics %>% filter(grepl("Northeastern",INSTNM),CARNEGIE==15) %>% select(UNITID)


research = characteristics %>% filter(CARNEGIE==15) %>% select(UNITID)

majors = data %>% inner_join(NEU) %>% mutate(AWLEVEL=as.numeric(AWLEVEL),MAJORNUM=as.numeric(MAJORNUM)) %>% filter(AWLEVEL==5,MAJORNUM==1) %>% 
  mutate(subcip = gsub("\\..*","",CIPCODE)) %>% 
  filter(subcip!="99" && ) %>%
  group_by(year) %>% mutate(year_total=sum(degrees)) %>% 
  group_by(year,CIPCODE,subcip,year_total) %>%
  summarize(degrees = sum(degrees))

field= "CIPCODE"
  
majors %>% 
  inner_join(cips) %>%
  group_by_("year","Type") %>% 
  summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1]) %>% 
  group_by(Type) %>% filter(sum(degrees) > 100) %>% 
  mutate(scaled = scale(percent)) %>% 
  ggplot() + aes(x=year,y=percent) + geom_line() + scale_y_continuous(labels=scales::percent,limits=c(0,.05)) + facet_wrap(~Type)


```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}


inst_array = data %>% 
  filter(year %in% c(2013,2014,2015,2007,2008,2009)) %>%
  mutate(year = year > 2010) %>%
  mutate(AWLEVEL=as.numeric(AWLEVEL),MAJORNUM=as.numeric(MAJORNUM)) %>% 
  filter(AWLEVEL==5,MAJORNUM==1) %>% 
  inner_join(characteristics %>% select(UNITID,INSTNM)) %>% inner_join(cips) %>%
  group_by(Type,General,INSTNM,UNITID,year) %>% 
  summarize(degrees=sum(degrees)) %>%
  group_by(UNITID) %>%
  filter(sum(degrees) > 1000) %>%
  group_by(INSTNM,year) %>% mutate(percent = degrees/sum(degrees))

inst_array %>% select(-degrees) %>% spread(year,percent,fill=0) %>% mutate(change = `TRUE` - `FALSE`) %>% filter(Type %in% c("History","English"),`FALSE` > 0) %>% ungroup %>% transmute(Type,INSTNM,`TRUE` = `TRUE`*100,change = change*100) %>% arrange(change) %>% group_by(INSTNM) %>% filter(n() == 2) %>% gather(variable,value,change,`TRUE`) %>% 
  unite(v,Type,variable) %>% spread(v,value) %>% ggplot() +
  geom_text() + aes(x=History_change,y=English_change,label=INSTNM) + lims(x=c(0,5),y=c(0,8))
  
  mutate(t1 = Type) %>% spread()



inst_grid = inst_array %>%
  filter(General %in% c("Humanities","Social Science")) %>% select(-General) %>%
  filter(Type != "General") %>%
  spread(Type,degrees,fill = 0)
  


model = lm(History ~ ., data = inst_grid[,3:ncol(inst_grid)])
summary(model)
data_frame(name = inst_grid$INSTNM, prediction = predict(model), actual = inst_grid$History) %>% 
arrange(-(actual-prediction))



```
