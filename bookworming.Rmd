---
title: "Degrees_Bookworm"
output: html_document
---

```{r}
source("read_cips.R")

characteristics = read_csv("hd2017.csv")
cips = return_cips()
data = return_data()

long_term = read_tsv("long_term.txt")
ltotals = totals %>% group_by(year) %>% summarize(year_total = sum(year_total)) %>% mutate(source="IPEDS") %>% bind_rows(
  long_term %>% mutate(source="Old", year_total = total) %>% select(year=Year, year_total, people_total=total, source )
  )

pop = read_csv("pop_estimates.csv") %>% select(-junk)

tot_degrees = ltotals %>% group_by(year) %>% summarize(total_degrees = max(year_total))

```



```{r}
data = data %>%
  filter(CIPCODE != "99.0000", CIPCODE != "99") %>%
  mutate(AWLEVEL=as.numeric(AWLEVEL),MAJORNUM=as.numeric(MAJORNUM))

#data %>% filter(degrees > 1000, AWLEVEL==5) %>% arrange(-degrees)
#characteristics %>% filter(UNITID=="433387") %>% glimpse
```

Quick check: total number of degrees by year. This may not match up exactly with dept of ed figures because of missing schools, no-majors, or other things. But I just want to not double count. This is Associate's, Bachelor's, and Masters.
```{r}

data %>% group_by(year, AWLEVEL) %>% filter(AWLEVEL %in% c(3,5,7)) %>% tally(degrees) %>% ggplot() + geom_line(aes(x=year, y=n, color=factor(AWLEVEL)))
```


```{r}
undergrad_majors = data %>% filter(AWLEVEL==5, MAJORNUM==1)

undergrad_majors %>% group_by(year, race) %>% tally(degrees) %>% ggplot() + geom_line(aes(x=year, y = n, color = race)) + scale_y_log10()
```

Understanding by institutional control

A useful function applied over any previous grouping
```{r}

source("EDA_functions.R")

```

Public and private looks good. More public than private.

```{r}

majors_with_control = data %>% mutate(AWLEVEL=as.numeric(AWLEVEL),MAJORNUM=as.numeric(MAJORNUM)) %>% 
  filter(AWLEVEL==5,MAJORNUM==1) %>% 
  left_join(characteristics %>% select(UNITID,CONTROL)) %>%
  mutate(subcip = gsub("\\..*","",CIPCODE)) %>% 
  filter(subcip!="99") %>%
  group_by(year,AWLEVEL,MAJORNUM,CONTROL) %>% 
  mutate(year_total=sum(degrees)) %>% 
  group_by(year,CIPCODE,subcip,year_total,AWLEVEL,MAJORNUM,CONTROL) %>%
  summarize(degrees = sum(degrees))


control = data %>% 
  filter(AWLEVEL==5,MAJORNUM==1) %>%
  left_join(characteristics %>% select(UNITID,CONTROL)) %>%
  group_by(CONTROL,year) %>%
  summarize(count=sum(degrees)) %>% ungroup %>%
  mutate(CONTROL=factor(CONTROL,labels=c("public","not-for-profit private","for profit private", "NA"), exclude = NULL)) %>%
  group_by(year) %>% mutate(percent = count/sum(count)) %>% ungroup %>%
  arrange(-year)

ggplot(control) + geom_line(aes(x=year,y=percent,color=CONTROL)) + xlim(1995, 2000)

```


```{r, fig.width=6,fig.height=6}

library(ggrepel)

plottable = undergrad_majors %>% 
  into_major_nums %>% 
  left_join(cips,by=c("CIPCODE"="CIPCode"))

this_plot = plottable %>% filter(year >= 1985) %>%
    group_by(year,General,Type) %>%
    filter(General %in% c("Humanities")) %>% 
    filter(Type %in% c("English","History","Languages and Literature","Philosophy","Area Studies")) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1]) %>% filter(!(Type=="Area Studies" && year < 1997))
  
this_plot %>% ggplot(aes(x=year,y=percent,fill=Type,label=Type,color=Type)) +
    geom_line() + 
    scale_y_continuous(labels=scales::percent) + 
#    facet_wrap(~Type,scales="free_y") + 
   theme(legend.position="none") + 
    labs(title="The big humanities majors\ncontinue to decline",subtitle="As percentage of all BAs; all US institutions",
         caption = "IPEDS data (preliminary for 2017)\nChart by Ben Schmidt, 2018") + geom_text_repel(data=this_plot %>% filter(year==2005))

this_plot %>%
  group_by(Type) %>%
  mutate(degrees = degrees/max(degrees)) %>% 
  ggplot(aes(x=year,y=degrees,fill=Type,label=Type,color=Type)) +
    geom_line() + 
    scale_y_continuous("Percent change from maximum number of BAs", labels=scales::percent) + 
#    facet_wrap(~Type,scales="free_y") + 
   theme(legend.position="none") + 
    labs(title="The big humanities majors\ncontinue to decline",subtitle="Raw number of BAs; all US institutions",
         caption = "IPEDS data (preliminary for 2017)\nChart by Ben Schmidt, 2018") + geom_text_repel(data=this_plot %>% group_by(Type) %>%
  mutate(degrees = degrees/max(degrees)) %>% filter(year==2017))

```


Load American Academy Taxonomy.

```{r, fig.width=8, fig.height=7}


#add_amacad_groupings = . %>%
#  group_by(year, CIPCODE, add = T) %>% 
#  summarize(degrees = sum(degrees)) %>%
#  left_join(amadjusted)

d3 = data %>% 
  filter(AWLEVEL==5) %>% 
  group_by(year, CIPCODE, MAJORNUM) %>%
  summarize(degrees = sum(degrees)) %>%
  acadjoin()
#   add_amacad_groupings()

totals = d3 %>% 
  group_by(year) %>% 
  summarize(year_total = sum(degrees, na.rm=T), people_total = sum(degrees[MAJORNUM==1], na.rm=T))

this_plot = d3 %>%
  group_by(year, Discipline) %>%
  filter(Bachelors=="Humanities") %>%
  summarize(degrees = sum(degrees, na.rm=T)) %>%
  ungroup %>% 
  filter(!is.na(Discipline)) %>%
  group_by(Discipline, year) %>%
  summarize(degrees = sum(degrees, na.rm=T)) %>%
  ungroup %>% 
  inner_join(totals) %>% 
  mutate(percent = degrees/year_total) %>%
  group_by(Discipline) %>% 
  filter(2007 %in% year) %>%
  mutate(relative = percent/percent[year==2007]) %>%
  filter(year > 1998) %>%
  group_by(Discipline) %>%
  mutate(size = factor(round(.5 + log(mean(percent), base = 9))))

this_plot %>% ungroup %>% mutate(total = sum(degrees)) %>% group_by(size, total) %>% summarize(count=sum(degrees))

this_plot %>% inner_join(totals) %>% 
  mutate(percent = degrees/year_total) %>% ggplot() + 
  aes(x=year,y=percent, color=Discipline) + 
  facet_wrap(~size, scales="free_y") +
  geom_line() + scale_y_continuous(limits = c(0,NA)) + 
  geom_text_repel(data = this_plot %>% filter(year==2016), aes(label=Discipline)) + 
  theme(legend.position="none") + labs(
    title="20-year trajectories of all humanities fields,\nshare of degrees",
    subtitle = "Categories from American Academy of Arts and Sciences Humanities Indicators\nGrouped by size. 85% of all degrees on this chart are in the top left corner.",
    caption = "Ben Schmidt with IPEDS data and American Academy of Arts and Sciences Taxonony\nI don't think Communications is a humanities field, but the Academy does, so I'm including it.") + scale_y_continuous(labels=scales::percent)


```


```{r}

tot_degrees %>% tail

this_plot = long_term %>% mutate(source = "old") %>% select(year = Year, Discipline = variable, degrees = count, source) %>% 
  filter(Discipline != "All Others", year < 2000) %>% 
  bind_rows(
    this_plot %>% 
      #filter(grepl("(English Language and Literature|History|Languages|Philosophy)", Discipline)) %>% 
      filter(!grepl("(Communication|Liberal Studies)", Discipline)) %>%
      select(year, Discipline, degrees) %>% mutate(source="new") %>% filter(year >= 2000)
  ) %>% 
  mutate(Discipline = fct_recode(Discipline, c("English" = "English Language and Literature"), c("Languages" = "Languages and Literatures Other than English"))) %>%
  inner_join(pop) %>%
  inner_join(tot_degrees) %>%
  group_by(Discipline) %>% 
  mutate(years = sum(degrees)) %>%
  mutate(longterm = years > 300000) %>%
  distinct(year, Discipline, .keep_all = T)
this_plot %>%  ggplot() + 
  geom_area(aes(color = reorder(Discipline, years), x = year, y = degrees/total_degrees,
                alpha = longterm,
                fill=reorder(Discipline, years))) + labs(
    fill = "Discipline",
    title = "Degrees per 1000 23-year-olds in the United States",
    subtitle = "Humanities Fields: long term data only for four largest.",
    caption = "Ben Schmidt: Data from IPEDS/Taxonomy from American Academy.\nCounting each degree for double majors after 2000."
) + scale_color_discrete(guide = 'none') + scale_alpha_discrete(guide='none') + scale_y_continuous(labels = scales::percent)

this_plot %>% filter(Discipline=="English") %>% select(year, Discipline, degrees, all_majors = total_degrees) %>% filter(year > 2000) %>% write_csv("english.csv")

this_plot %>% 
  filter(longterm==TRUE) %>%
  group_by(year) %>% summarize(share = sum(degrees)/collegepop[1]) %>% 


```
```{r}
d = long_term %>% mutate(source = "old") %>% select(year = Year, Discipline = variable, degrees = count, source) %>% 
  filter(Discipline != "All Others", year < 2000) %>% 
  bind_rows(
    this_plot %>% 
      #filter(grepl("(English Language and Literature|History|Languages|Philosophy)", Discipline)) %>% 
      filter(!grepl("(Communication|Liberal Studies)", Discipline)) %>%
      select(year, Discipline, degrees) %>% mutate(source="new") %>% filter(year >= 2000)
  ) %>% 
  mutate(Discipline = fct_recode(Discipline, c("English" = "English Language and Literature"), c("Languages" = "Languages and Literatures Other than English"))) %>%
  inner_join(pop) %>%
  inner_join(tot_degrees) %>% group_by(year, total_degrees, collegepop) %>% 
  summarize(humanities = sum(degrees)) %>% 
  ungroup %>% arrange(year) %>% 
  mutate(deg_share = total_degrees/collegepop) %>%
  mutate(hum_share = humanities/total_degrees) %>%
  mutate(hum_change = hum_share/lag(hum_share, 1) - 1) %>%
  mutate(deg_change = deg_share/lag(deg_share, 1) - 1)

d %>% filter(year >= 1960) %>% ggplot() +
  aes(x=deg_change, y = hum_change, label=year, color=year) + 
  geom_path() + geom_text(
    data=d %>% filter(year %% 5 == 0, year >= 1960)
  )
```

```{r}
this_plot %>% filter(Discipline %in% c("English", "History", "Languages", "Philosophy")) %>% ggplot() + 
  geom_area(aes(color = reorder(Discipline, years), x = year, y = degrees/total_degrees,
                fill=reorder(Discipline, years))) + 
  labs(    fill = "Discipline",
    title = "Humanities Degrees as percentage of all US college degrees, 1948-2017",
    caption = "Ben Schmidt: Data from IPEDS/Taxonomy from American Academy.\nCounting each degree for double majors after 2000.") + 
  #geom_vline(xintercept=2011, alpha=1, lty=2, color="black") + 
  scale_color_discrete(guide = 'none') + scale_y_continuous(labels = scales::percent) + 
  annotate("text", label="I say not to worry\nbased on 2011 data", x = 2007.8, hjust=1, y = .11, lineheight=.75) + 
  annotate("text", label = stringr::str_wrap("Shift to counting double majors artificially increases humanities share in 2001", width = 26), x = 1997.5, y = .05, hjust = 1, lineheight=.75) + 
  annotate("segment", x = 1997.5, xend = 2000, y = .05, yend = .069) + 
  annotate("segment", x = 2007.8, xend = 2011, y = .11, yend = .0739)

```

Why is English *so* bad in 2010? The answer: CIPS changed the reporting from "Speech and rhetorical studies" to "rhetoric and composition," and that lost a few thousand degrees in a batch.

``` {r}
engq = plottable %>% filter(year > 2008, year < 2011) %>% filter(Type=="English")
engq %>% ungroup %>% mutate(lab = paste(CIP2010, CIPTitle)) %>% select(year, degrees, lab) %>% spread(year, degrees) %>% mutate(change = `2009` - `2010`) %>% arrange(-change)

```



Most fields are about the same as percentage of major #2 as major #1, except Languages which are often *much* higher.


```{r}
with_num = data %>% ungroup %>% group_by(MAJORNUM) %>% filter(AWLEVEL==5) %>% into_major_nums

with_num %>% mutate(percent = degrees/year_total) %>% left_join(cips,by=c("CIPCODE"="CIPCode")) %>%
  group_by(Type, year, General, MAJORNUM) %>% summarize(percent = sum(percent)) %>% filter(General=="Humanities") %>% ggplot() + geom_line(aes(x=year,y=percent,color=Type, lty=factor(MAJORNUM)))
```

```{r}
with_num = data %>% ungroup %>% filter(AWLEVEL==5, MAJORNUM==1) %>% into_major_nums %>% left_join(cips,by=c("CIPCODE"="CIPCode"))

with_num  %>% group_by(year, CIPCODE,CIPTitle) %>% summarize(degrees=sum(degrees)) %>%
  group_by(CIPCODE, CIPTitle) %>%
  summarize(min = max(year[degrees < degrees[year==2017]])) %>% arrange(min) %>% filter(min > 0)

```

Other fields?



Political Science and economics are also in trouble.

```{r fig.width=5, fig.height=8}

annual_majors = data %>% filter(AWLEVEL==5, MAJORNUM==1) %>% into_major_nums

this_plot = annual_majors %>% 
  acadjoin() %>% cipsjoin() %>% 
  mutate(percent = degrees/year_total) %>%
  group_by(Type, year, General) %>% 
  summarize(percent = sum(percent)) %>%
  group_by(Type) %>%
  filter(General %in% c("Social Science", "Humanities"), max(percent) > .005, Type != "General") %>%
  group_by(Type) %>% mutate(percent=percent/(percent[year==2008]))


this_plot %>% 
  ggplot() + 
  aes(x=year,y=percent, color=Type, label = Type) +
  geom_line() + 
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~General, scales="free_y") + 
  theme(legend.position="none") + 
    labs(title="Changes in Major share since 1997",subtitle="As share of BA, relative to 2008 numbers; all US institutions.",
         caption = "IPEDS data (preliminary for 2017)\nChart by Ben Schmidt, 2018.") + 
  geom_text_repel(data=this_plot %>% filter(year==2017))
```
```{r fig.width = 8, fig.height = 12}
this_plot = annual_majors %>% 
  cipsjoin %>%
  group_by(year) %>% mutate(year_totals = sum(degrees)) %>%
  group_by(Type, General, year_totals) %>% mutate(degrees = sum(degrees)) %>% 
  mutate(percent = degrees/year_totals) %>%
  group_by(Type, General) %>%
  filter(max(percent) > .005, Type != "General")

d = this_plot %>%
ggplot() + geom_line() + aes(x = year, y = percent, color=Type, group=General) + facet_wrap(~ General + Type, scales="free", ncol = 4, labeller = labeller(label_wrap_gen(10))) + theme(legend.position="none") + scale_y_continuous(labels=scales::percent) + expand_limits(y = 0) + labs(title="Share of various disciplines", subtitle="Percent of all college majors.") + geom_vline(xintercept =2011, col="blue", lty=2, alpha = .6)
d
ggsave(plot = d, device = "png", filename="~/fullshare.png", width=8, height=12)
```




```{r}

library(forcats)

this_plot = data %>% filter(year==2017, AWLEVEL==5) %>% mutate(year_total = n()) %>% 
  left_join(cips, by=c("CIPCODE"="CIPCode")) %>%
  filter(General=="Humanities") %>%
  mutate(label = paste0(CIPCODE, CIPTitle)) %>% 
  mutate(label = forcats::fct_lump(label, n = 50)) %>%
  group_by(label, Type, year_total) %>% summarize(count=n()) %>% 
  ungroup %>%
  mutate(label = fct_reorder(label, count)) 

this_plot %>%
  ggplot() + geom_point(aes(x=reorder(label, count), y = count, color=Type)) + coord_flip() + scale_y_log10()

```

```{r}
pl = plottable %>% group_by(CIPCODE, CIPTitle, year) %>% summarize(percent = sum(degrees)/year_total[1]) %>% mutate(dropping = percent  - lag(percent,1) < 0) %>% select(year, dropping, CIPTitle, CIPCODE, percent) %>% filter(!is.na(dropping)) %>% filter(grepl("History, General.", CIPTitle))

streaks = function(pl) {
  lengths = rle(pl$dropping)
  ends = cumsum(lengths$lengths)
  starts = cumsum(c(1, lengths$lengths[1:(length(ends) - 1)]))
  labs = paste(pl$year[starts],"-", pl$year[ends])
  change = (pl$percent[ends] - pl$percent[starts])/pl$percent[starts] * 100
  data_frame(dropping = lengths$values, length = lengths$lengths, label = labs, change = change)
}

pl = plottable %>% group_by(CIPCODE, CIPTitle, year) %>% summarize(percent = sum(degrees)/year_total[1]) %>%
  mutate(dropping = percent  - lag(percent,1) < 0) %>% filter(!is.na(dropping))

dropping_summaries = pl %>% do(streaks(.)) %>% arrange(-length)
dropping_summaries %>% filter(dropping == FALSE) %>% arrange(-length) %>% head(10) %>% select(CIPCODE, CIPTitle, label, length, change)

dropping_summaries %>% filter(dropping == TRUE) %>% arrange(-length) %>% head(10) %>% select(CIPCODE, CIPTitle, label, length, change)

plottable %>% filter(CIPCODE %in% c("31.0505", "54.0101", "45.0801")) %>% mutate(percent = degrees/year_total) %>% ggplot() + geom_line(aes(x=year,y=percent, color = CIPTitle))
```


```{r}

this_plot = plottable %>% filter(year >= 1980) %>%
    group_by(year,General,Type) %>%
    filter(
      Type %in% c("English","History","Philosophy","Area Studies", "Languages and Literature")
      ) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1])



this_plot %>% ggplot() + geom_line(aes(x=year,y=percent, color=Type))

```

```{r fig.width=4,fig.height=4}
tp2 = this_plot %>% 
  group_by(Type) %>% 
  mutate(peak = max(percent)) %>% 
  mutate(relative = percent/peak) 

tp2 %>%
  ggplot(aes(x=year,y=relative-1,fill=Type,label=Type,color=Type)) +
    geom_line() + 
    scale_y_continuous("Percentage decline from peak", labels=scales::percent, limits = c(-.5, 0)) + 
   theme(legend.position="none") + 
    labs(title="Humanities majors continue to fall",subtitle="Decline from peak share of degrees since 1997\nall US institutions",
         caption = "IPEDS data (preliminary for 2016/2017)\nChart by Ben Schmidt, 2018") + geom_text_repel(data=tp2 %>% filter(year==2017)) 
```

```{r fig.width=4,fig.height=4}
tp2 = this_plot %>% 
  group_by(Type) %>% 
  mutate(peak = max(percent)) %>% 
  mutate(relative = percent/peak) 

tp2 %>%
  ggplot(aes(x=year,y=relative-1,fill=Type,label=Type,color=Type)) +
    geom_line() + 
    scale_y_continuous("Percentage decline from peak", labels=scales::percent, limits = c(-.75, 0)) + 
   theme(legend.position="none") + 
    labs(title="Humanities double majors are also falling",subtitle="Decline from peak share of minors since 1997\nall US institutions\n(eg, 'History and Computer Science')",
         caption = "IPEDS data (preliminary for 2017)\nChart by Ben Schmidt, 2018") + geom_text_repel(data=tp2 %>% filter(year==2017)) 
```


```{r}
plottable %>% filter(year > 2000) %>%
    group_by(year,General,Type) %>%
    filter(General %in% c("Humanities")) %>% 
    filter(Type %in% c("English","History","Languages and Literature","Philosophy","Area Studies")) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1]) %>%
    group_by(year) %>% summarize(percent = sum(percent),degrees=sum(degrees)) %>% filter(year > 2008)

```

```{r fig.height=6,fig.width=9}
change = plottable %>% group_by(year,Type,General) %>% summarize(degrees=sum(degrees,na.rm=T)) %>% group_by(Type,General) %>%
  summarize(nineties = sum(degrees[year >= 1995 & year <= 2000],na.rm=T), recent = sum(degrees[year >= 2012 & year <= 2013]), now = sum(degrees[year >= 2016]))

grid_change = change %>% ungroup %>% filter(nineties > 0, nineties * 3 > recent) %>% 
  mutate(n_share = nineties/sum(nineties), r_share = recent/sum(recent),now_share = now/sum(now),
         recent_change = now_share/r_share,
         long_change = now_share/n_share,
         total = sum(now_share)
         )

grid_change %>% filter(Type!="General") %>% ggplot() + geom_text_repel(aes(x=recent_change,y=long_change,label=Type,color=General,size=now_share)) + 
  scale_x_log10("Level compared to 2012-2013",breaks = c(.5,.7,.8,.9,1,1.2,1.5,2),labels=scales::percent) + scale_y_log10("Level compared to 1995-2000",breaks = c(.5,.7,.8,.9,1,1.2,1.5,2),labels=scales::percent) + scale_size_continuous(trans="sqrt") +
  annotate("text",alpha=.3,label="Increasing",size=16,x=1.3,y=2.2) + 
  annotate("text",alpha=.3,label="Decreasing\nafter\nlong-term\nincrease",size=12,x=.8,y=2.2) +
  annotate("text",alpha=.3,label="Decreasing",size=16,x=.75,y=.8) + 
  annotate("text",alpha=.3,label="Increasing\nafter\nlong-term\ndecrease",size=12,x=1.2,y=.6) +
  geom_hline(yintercept=1,size=3,lty=2,alpha=.4) + 
  geom_vline(xintercept=1,size=3,lty=2,alpha=.4)

```



```{r cars}

top30 = characteristics %>% 
  filter(grepl("Harvard|Yale|Princeton|Dartmouth|University of Pennsylvania|Brown|University of Chicago|Stanford|Columbia University|Duke|Massachusetts Institute|University of Pennsylvania|Johns Hopkins|California Institute|Northwestern|Cornell|Rice|Notre Dame|Vanderbilt|Washington University|Georgetown|Berkeley|Southern California|Carnegie Mellon|Los Angeles|University of Virginia|Tufts|Ann Arbor|Wake Forest|Chapel Hill",INSTNM), CARNEGIE==15) %>% 
  mutate(elite = TRUE) %>% 
  select(UNITID, elite)

# Not including the military academies.

p3 = data %>% filter(AWLEVEL==5, MAJORNUM==1) %>%
  inner_join(top30) %>% 
 # mutate(gender="all") %>%
#  group_by(gender) %>% 
  into_major_nums %>%
  acadjoin %>%
#    mutate(Type = ifelse(Type %in% c("General","Humanities"), "General Humanities",Type)) %>%
    group_by(Bachelors, Discipline, year) %>%
#    filter(General %in% c("Humanities","Social Science")) %>% 
#    filter(Type %in% c("English","History","Languages and Literature","Philosophy")) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1]) %>%
  filter(year > 1997) %>%
  mutate(relative = 1 - percent/max(percent), peak_year = year[percent==max(percent)][1])

p3 %>% filter(year==2017, Discipline != "Agriculture") %>% 
  ungroup %>%
  mutate(Discipline = paste0(Discipline, " (peak ", peak_year, ")")) %>% arrange(relative) %>% ungroup %>% select(relative, peak_year, Discipline, percent) %>% ggplot() + geom_point(aes(size=percent, x=reorder(Discipline, peak_year), y = -relative)) + coord_flip() + scale_y_continuous("Change from peak", labels = scales::percent) + scale_x_discrete("Discipline") + scale_size_continuous("Percentage of degrees\nin 2017", trans="sqrt", labels = scales::percent, breaks = c(.01, .1, .5, 1, 2)/100) + labs(title="Fall at elite colleges\nin share of humanities majors", caption = "Ben Schmidt, 2018: Data from IPEDS, taxonomy from American Academy")

    #filter(sum(degrees) > 1000) %>%
p3 %>% filter(year > 1997, Bachelors %in% c("Humanities", "Social & Behavioral Sciences")) %>%
    ggplot(aes(x=year,y=relative,fill=Discipline)) +
    geom_line() + 
    scale_y_continuous(labels=scales::percent) + 
expand_limits(y = 0) +     facet_wrap(~Discipline,scales="free_y") + 
    labs(title="Various majors, as percent of all BAs\nat the top 30 universities according to US News")# + geom_point(data=data_frame(year=2000,percent=0,Type=unique(p3$Type),alpha=0))


```

```{r}
HSIs = data_frame(UNITID = c(126182, 126207, 108807, 110468, 222567, 222576, 241100, 241128, 222831, 109350, 245838, 448886, 407009, 104160, 440651, 439446, 241216, 222992, 474863, 109785, 109819, 444398, 132471, 109907, 241225, 183743, 125170, 234711, 189413, 262086, 223506, 223524, 132709, 110334, 110361, 110918, 478634, 485263, 110413, 110529, 110486, 441937, 110538, 110547, 110574, 110556, 110565, 110583, 110592, 409698, 110608, 110617, 110510, 366711, 110495, 150172, 165167, 111434, 129367, 241377, 241386, 363907, 363916, 132842, 241331, 111638, 439367, 104346, 187532, 376950, 111887, 111896, 111920, 111939, 112172, 417327, 475477, 434539, 144209, 144184, 144166, 144193, 144218, 187639, 223320, 112385, 104425, 241720, 126872, 448761, 474890, 388520, 146472, 118347, 193399, 122791, 182005, 111461, 113573, 226408, 123217, 128106, 234979, 420556, 446163, 112826, 113111, 113193, 184205, 190521, 190530, 190567, 190585, 190594, 190600, 190628, 190637, 190655, 190664, 190673, 113218, 113236, 113333, 224350, 436465, 434900, 449144, 443562, 449135, 469416, 485421, 154998, 190761, 148496, 155007, 113856, 413802, 187648, 187666, 383996, 224572, 133508, 243832, 241836, 112686, 113980, 224615, 224642, 144944, 241951, 184481, 384333, 114266, 184603, 184612, 133951, 114789, 114813, 114859, 224961, 155104, 105145, 114938, 104708, 115001, 115126, 115296, 225201, 115393, 235422, 134495, 367884, 115728, 129543, 225399, 225423, 225520, 184995, 242121, 115755, 115773, 115861, 242556, 242042, 242565, 242583, 242626, 242635, 242644, 242705, 242680, 242699, 242653, 242662, 242617, 225876, 116712, 185262, 135081, 117627, 117195, 226134, 366401, 226204, 117104, 192563, 117636, 227182, 117645, 117788, 117803, 117690, 117867, 117706, 117715, 117724, 117733, 117894, 363633, 118541, 226578, 118684, 118718, 193016, 118772, 188261, 135717, 185536, 226806, 118912, 118976, 119067, 119137, 460394, 147411, 209241, 119173, 226930, 119164, 119216, 119331, 147536, 119605, 185129, 187897, 187967, 187903, 187994, 188003, 187620, 188021, 188030, 460464, 227191, 227225, 147776, 167376, 188058, 420398, 130004, 120184, 136215, 194161, 227304, 120342, 194240, 127778, 227331, 120421, 120768, 120865, 136358, 246354, 120953, 120971, 121044, 186034, 105428, 440794, 105525, 456481, 456490, 241395, 243586, 241410, 121363, 127884, 241766, 215585, 117052, 223463, 377111, 380094, 451857, 445203, 135939, 227766, 121886, 121901, 148335, 449506, 122180, 122205, 148876, 227845, 137272, 123554, 186432, 148627, 227924, 123527, 122339, 122375, 122409, 122597, 227979, 122658, 122746, 122755, 430670, 121619, 122889, 188137, 122977, 123013, 399212, 228042, 155858, 123341, 123509, 123563, 123572, 137315, 105792, 228158, 409315, 382911, 228316, 228468, 123800, 167905, 228149, 227854, 137476, 475565, 228501, 197294, 124113, 228547, 226152, 224147, 228705, 228981, 229319, 229328, 228459, 229179, 227377, 228796, 229027, 228644, 416801, 229018, 227368, 485078, 128258, 431929, 135610, 149532, 182500, 187198, 206279, 376385, 241191, 243568, 243346, 243443, 243601, 241739, 441690, 243577, 241614, 445188, 110671, 110705, 110714, 225511, 225414, 225432, 225502, 145600, 117140, 187976, 187985, 188225, 188049, 484905, 243106, 243115, 243133, 243142, 243151, 243179, 243197, 243203, 243212, 243221, 243188, 227863, 225627, 188182, 449870, 429128, 138187, 123651, 188340, 125028, 125091, 229540, 149727, 229780, 236975, 125462, 448594, 125471, 125499, 188304, 229832, 229841, 125763, 187444, 125897, 455512, 237109, 126119), HSI = TRUE)
```

```{r fig.width=5, fig.height=6}
top30LA = characteristics %>% filter(grepl("^(Williams|Amherst|Bowdoin|Swarthmore|Wellesley|Middlebury|Pomona|Carleton|Claremont McKenna|Davidson|Washington and Lee|Colby|Colgate|Harvey Mudd|Smith|Vassar|Grinnell|Hamilton|Haverford|Wesleyan University|Bates|Colorado College|University of Richmond|Oberlin College|Scripps College|Bryn Mawr)", INSTNM), CARNEGIE==31) %>% mutate(elite = TRUE) %>% select(UNITID, elite)


charelite = top30LA %>% rbind(top30) %>% right_join(characteristics) %>% left_join(HSIs)

charelite = charelite %>% mutate(
  label = 
    case_when(
      elite ~ case_when(
        CARNEGIE == 15 ~ "Elite Research Universities",
        CARNEGIE == 31 ~ "Elite Liberal Arts Colleges"
      ),
      HBCU == 1 ~ "HBCU",
      HSI == 1 ~ "HSI",
      CARNEGIE %in% c(15, 16) ~ "Research Universities",
      CARNEGIE %in% c(21, 22) ~ "Masters College/University",
      CARNEGIE %in% c(31, 32) ~ "Bachelor's Colleges",
      TRUE ~ "Other"
    )
)
```
```{r}



BYU = characteristics %>% filter(grepl("Texas at Austin|Howard University|Brigham.*Provo|Yale University|Naval Academy|Bob Jones|Wellesley College", INSTNM)) %>% inner_join(data) %>% filter(AWLEVEL==5, MAJORNUM==1) %>% acadjoin %>% group_by(INSTNM,  Discipline, Bachelors, year) %>% summarize(degrees=sum(degrees)) %>% filter(year >= 2003 || INSTNM != "United States Military Academy")

BYU %>% group_by(Discipline) %>% tally(degrees) %>% arrange(-n)
# 
BYU %>% filter(year >= 1998) %>% group_by(INSTNM, year) %>% mutate(total = sum(degrees)) %>% filter(Bachelors=="Humanities", Discipline != "General Humanities/Liberal Studies") %>% group_by(Bachelors, INSTNM, year) %>% summarize(percent = sum(degrees)/total[1]) %>%
  ggplot() + geom_line(aes(x=year, y = percent)) + labs(title = "") + facet_wrap(~INSTNM, scales="free_y") + expand_limits(y=0) + scale_y_continuous(labels = scales::percent) + labs(title="Share of humanities degrees at six extremely different institutions", subtitle ="(excluding general liberal arts--including communications)")
```

```{r}
d4 = data %>% filter(AWLEVEL==5, MAJORNUM == 1) %>% 
  group_by(year, CIPCODE, UNITID) %>% 
  summarize(degrees = sum(degrees)) %>%
  inner_join(amadjusted)

totals = d4 %>% 
  group_by(year, UNITID) %>% 
  summarize(year_total = sum(degrees, na.rm=T), people_total = sum(degrees, na.rm=T)) %>%
  inner_join(charelite) %>%
  group_by(label, year) %>% summarize(year_total = sum(year_total, na.rm=T))


elite_humanities = d4 %>% 
  filter(Bachelors=="Humanities") %>% 
  group_by(UNITID, year, Discipline) %>% 
  summarize(degrees = sum(degrees)) %>%
  inner_join(charelite) %>% 
  group_by(year, label) %>%
 # filter(Discipline != "Communications", Discipline != "General Humanities/Liberal Studies") %>%
  summarize(degrees = sum(degrees, na.rm = T)) %>%
  inner_join(totals) %>%
  filter(label != "Other", year > 1997) %>%
  group_by(label) %>%
  mutate(percent = (degrees/year_total)/(degrees/year_total)[year==2008])

elite_humanities %>%
  ggplot() + aes(x=year, y = percent, color=label, label = label) + geom_line() + 
  labs(title = "Humanities degree share by institution class", 
       subtitle = "'Elite' schools in the top 30 per US News and World Report",
       caption = "Ben Schmidt, 2018. Data from IPEDS.\n2000 Carnegie classifications. Military academies dropped from elite.") + 
  theme(legend.position="none") + 
  scale_y_continuous("Percent of degrees at institution type", label = scales::percent) + geom_text_repel(data = elite_humanities %>% filter(label != "Other", year == 2017))

```

```{r}
elite_humanities %>% filter(year==2017) %>% arrange(degrees/year_total) %>% mutate(t = degrees/year_total)
```

```{r}
race = data %>% filter(AWLEVEL==5, MAJORNUM==1) %>% group_by(race, gender) %>% into_major_nums %>% acadjoin

race %>% group_by(year, race, gender, Bachelors) %>% 
  filter(Discipline != "Communications", race != "All", race != "Unknown", race != "Two or more races", race != "Nonresident alien") %>%
  summarize(degrees = sum(degrees), year_total = year_total[1]) %>%
  mutate(percent = degrees/year_total) %>% 
  filter(Bachelors=="Humanities") %>%
  ggplot() + geom_line(aes(x=year, y = percent, color=race, pch=race)) + facet_wrap(~gender) + labs("Share of non-Communications Humanities degrees,\nby race and gender") + scale_y_continuous(labels=scales::percent) + expand_limits(y=0)

```

```{r}

race = data %>% filter(AWLEVEL==5, MAJORNUM==1) %>% group_by(race, gender) %>% into_major_nums %>% acadjoin

race %>% group_by(year, race, gender, Bachelors) %>% 
  filter(Discipline != "Communications") %>% 
  summarize(degrees = sum(degrees), year_total = year_total[1]) %>%
  mutate(percent = degrees/year_total) %>% 
  group_by(race, gender) %>% filter (sum(degrees) > 15000, race!="All", race != "Unknown", race != "American Indian or Alaska Native") %>%
  mutate(relative = percent/percent[year==2009]) %>%
  filter(Bachelors=="Humanities") %>%
  ggplot() + geom_line(aes(x=year, y = relative, color=race, pch=race)) + facet_wrap(~gender) + labs("Share of non-Communications Humanities degrees,\nby race and gender") + scale_y_continuous(labels=scales::percent) + expand_limits(y=0)

```

```{r}

race %>% group_by(year, race, gender, Bachelors) %>% 
  filter(Discipline != "Communications", race != "All") %>% 
  mutate(resident = race != "Nonresident alien") %>%
  group_by(year,resident,Bachelors,gender) %>%
  summarize(degrees = sum(degrees), year_total = year_total[1]) %>%
  mutate(percent = degrees/year_total) %>% 
  filter(Bachelors=="Humanities") %>%
  ggplot() + geom_line(aes(x=year, y = percent, color=resident)) + labs("Share of non-Communications Humanities degrees,\nby US resident status") + facet_wrap(~gender) +  scale_y_continuous(labels=scales::percent) + expand_limits(y=0)

```

```{r}
awlevels = data %>% group_by(AWLEVEL) %>% 
  into_major_nums %>% mutate(level = case_when(
  AWLEVEL==5 ~ "BA",
  AWLEVEL %in% c(9, 17, 18, 19) ~ "PhD"
)) %>% acadjoin()

```

```{r}
library(ggrepel)
bachlevels = awlevels %>% group_by(level, Bachelors, year) %>% filter(level=="BA") %>% summarize(count = sum(degrees, na.rm=T)) %>% select(field = Bachelors, level, year, count)

dlevels = awlevels %>% group_by(level, Doctoral, year) %>% filter(level=="PhD") %>% summarize(count = sum(degrees, na.rm = T)) %>% select(field = Doctoral, level, year, count)

joint = bachlevels %>% bind_rows(dlevels) %>% spread(level, count) 

joint %>% filter(year > 1984, !is.na(field)) %>% ggplot() + 
  geom_line(aes(x=year, y=`BA`/`PhD`)) + facet_wrap(~field, scales="free") + labs(title="Bachelor's degrees per PhD, various fields")

joint %>% filter(field=="Humanities") %>% ggplot() + geom_point(aes(y=`PhD`, x = year))
```

```{r}

View(characteristics)
```

```{r}

school_counts = data %>% filter(AWLEVEL==5, (year > 2005 & year < 2008) | year > 2015) %>% group_by(CIPCODE, year < 2010, UNITID) %>% summarize(degrees = sum(degrees))

collegecounts = school_counts %>%
  acadjoin %>% 
  group_by(UNITID, Bachelors, Discipline, `year < 2010`) %>% 
  summarize(degrees = sum(degrees)) %>%
  group_by(UNITID, `year < 2010`) %>% 
  mutate(school_count = sum(degrees), percent = degrees/school_count)

shares = collegecounts %>% filter(Bachelors=="Humanities", min(school_count) > 500) %>% select(percent, UNITID, percent) %>% ungroup %>% spread(`year < 2010`, percent) %>% 
  transmute(UNITID, old_share = `TRUE`, new_share = `FALSE`)
shares
```


```{r}
counts = collegecounts %>% distinct(UNITID, `year < 2010`, school_count) %>% spread(`year < 2010`, school_count) %>% ungroup %>%  transmute(UNITID=UNITID, `old_count` = `TRUE`, new_count = `FALSE`)

shared = counts %>% inner_join(shares)
```

```{r}

instidata = shared %>% mutate(change = `new_share`/`old_share`) %>% inner_join(characteristics) %>% 
  mutate(
  college_class = 
    case_when(
      CARNEGIE %in% c(15, 16) ~ "Research Universities",
      CARNEGIE %in% c(21, 22) ~ "Masters College/University",
      CARNEGIE %in% c(31, 32) ~ "Bachelor's Colleges",
      TRUE ~ "Other"
    ),
  locale = case_when(
      LOCALE < 13 ~ "Large City",
      LOCALE <= 23 ~ "Small city or suburb",
      TRUE ~ "Rural or small town"
    )
  )
instidata = instidata %>% 
  mutate(
    LANDGRNT_f = relevel(factor(LANDGRNT), ref=2),
    college_class_f = relevel(factor(college_class), ref="Other"),
    locale_f = relevel(factor(locale), ref="Small city or suburb"),
    control = relevel(factor(CONTROL, levels = c(1,2,3), labels = c("Public", "Nonprofit", "For Profit")), ref="For Profit"),
    hbcu = relevel(factor(HBCU), ref=2))



model = lm(log(change) ~ college_class_f + locale_f + control + hbcu, data = instidata) 
summary(model)
model2 = lm(log(change) ~ college_class_f, data = instidata)

predictions = predict(model2, newdata=instidata)

instidata %>% ungroup %>% mutate(p = predictions) %>% select(INSTNM, CARNEGIE, CONTROL, STABBR, old_count, new_count, old_share, new_share, change, p) %>% arrange(-change)  %>% filter(new_share > .02)
%>% ggplot() + geom_boxplot(aes(x=factor(CARNEGIE), y = change)) + scale_y_log10()

model %>% summary

shares %>% mutate(change = `FALSE`/`TRUE`) %>% inner_join(characteristics) %>% filter(STABBR=="MA") %>% ggplot() + 
  geom_point(aes(x=reorder(INSTNM, change), y = `change`), color='red') +
  coord_flip() + scale_y_log10()

```

```{r}

characteristics %>% filter(INSTNM %in% c("Pomona College", "Princeton University")) %>% inner_join(data) %>% filter(AWLEVEL==5, year > 2003) %>% acadjoin %>% group_by(INSTNM,year) %>% mutate(school_count = sum(degrees)) %>% group_by(Bachelors, school_count, add=T) %>% summarize(degrees = sum(degrees)) %>% mutate(percent = degrees/school_count) %>% filter(Bachelors=="Humanities") %>% ggplot() + geom_line(aes(x = year, y = percent)) + facet_grid(Bachelors~INSTNM, scales="free") + scale_y_continuous(labels=scales::percent)
```

```{r}
CS = data %>% filter(AWLEVEL==5) %>% 
  cipsjoin %>%
  group_by(UNITID, year, Type) %>% summarize(degrees = sum(degrees)) %>%
  group_by(UNITID, year) %>%
  mutate(year_total = sum(degrees)) %>% 
  filter(Type=="Computer Science") %>% 
  inner_join(charelite) %>%
  group_by(year, label) %>%
  summarize(degrees = sum(degrees, na.rm = T), year_total = sum(year_total, na.rm = T))



CS %>%
  filter(label != "Other") %>%
  ggplot() + aes(x=year, y =degrees/year_total, color=label, label = label) + geom_line() + 
  labs(title = "CS degree share by institution class", 
       subtitle = "'Elite' schools in the top 30 per US News and World Report",
       caption = "Ben Schmidt, 2018. Data from IPEDS.\n2000 Carnegie classifications. Military academies dropped from elite.") + 
  theme(legend.position="none") + 
  scale_y_continuous("Percent of degrees at institution type", label = scales::percent) + geom_text_repel(data = CS %>% filter(label != "Other", year == 2017))

```

```{r cars}
top30 = characteristics %>% filter(grepl("Harvard|Yale|Princeton|Dartmouth|University of Pennsylvania|Brown|University of Chicago|Stanford|Columbia University|Duke|Massachusetts Institute|University of Pennsylvania|Johns Hopkins|California Institute|Northwestern|Cornell|Rice|Notre Dame|Vanderbilt|Washington University|Georgetown|Berkeley|Southern California|Carnegie Mellon|Los Angeles|University of Virginia|Tufts|Ann Arbor|Wake Forest|Chapel Hill",INSTNM),CARNEGIE==15) %>% select(UNITID,INSTNM)

top1 = characteristics %>% filter(grepl("Yale University",INSTNM),CARNEGIE==15) %>% select(UNITID,INSTNM)

p3 = data %>% filter(AWLEVEL==5) %>%
  inner_join(top30) %>% 
  mutate(gender="all") %>%
  group_by(gender) %>% 
  into_major_nums %>%
  inner_join(cips,by=c("CIPCODE"="CIPCode")) %>%
    mutate(Type = ifelse(Type %in% c("General","Humanities"), "General Humanities",Type)) %>%
    group_by(year,General,Type,gender) %>%
#    filter(General %in% c("Humanities","Social Science")) %>% 
#    filter(Type %in% c("English","History","Languages and Literature","Philosophy")) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1])
    #filter(sum(degrees) > 1000) %>%
  
p3
  
p3 %>% filter(year > 1997) %>%
    ggplot(aes(x=year,y=percent,fill=Type)) +
    geom_line() + 
    scale_y_continuous(labels=scales::percent) + 
    facet_wrap(~Type,scales="free_y") + 
    labs(title="Various majors, as percent of all BAs\nat the top 30 universities according to US News")# + geom_point(data=data_frame(year=2000,percent=0,Type=unique(p3$Type),alpha=0))


```


```{r}
data %>% into_major_nums %>% 
  into_labeled %>%
    mutate(Type = ifelse(Type %in% c("General","Humanities"), "General Humanities",Type)) %>%
    group_by(year,General,Type) %>%
    filter(General %in% c("Humanities")) %>% 
    group_by(year,Type,CIPTitle) %>%
    #filter(Type %in% c("English","History","Languages and Literature","Philosophy")) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1]) %>% 
    #filter(sum(degrees) > 1000) %>%
    ggplot(aes(x=year,y=percent,fill=Type)) +
    geom_area() + 
    scale_y_continuous(labels=percent) + 
    facet_wrap(~CIPTitle,scales="free_y") + 
    theme(legend.position="none") + 
    labs(title="Various majors, as percent of all BAs\nat the top 30 universities according to US News")
```

```{r}
data %>% into_major_nums %>% into_labeled %>%
    mutate(Type = ifelse(Type %in% c("General","Humanities"), "General Humanities",Type)) %>%
    group_by(year,General,Type) %>%
    filter(General %in% c("Humanities")) %>% 
    group_by(year,Type,CIPTitle) %>%
    filter(Type %in% c("English","Communications")) %>%
    summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1]) %>% 
    #filter(sum(degrees) > 1000) %>%
    ggplot(aes(x=year,y=percent,fill=Type)) +
    geom_area() + 
    scale_y_continuous(labels=percent) + 
    facet_wrap(~CIPTitle,scales="free_y") + 
    theme(legend.position="none") + 
    labs(title="Various majors, as percent of all BAs\nat the top 30 universities according to US News")

```

```{r}
NEU = characteristics %>% filter(grepl("Northeastern",INSTNM),CARNEGIE==15) %>% select(UNITID)


research = characteristics %>% filter(CARNEGIE==15) %>% select(UNITID)

majors = data %>% inner_join(NEU) %>% mutate(AWLEVEL=as.numeric(AWLEVEL),MAJORNUM=as.numeric(MAJORNUM)) %>% filter(AWLEVEL==5,MAJORNUM==1) %>% 
  mutate(subcip = gsub("\\..*","",CIPCODE)) %>% 
  filter(subcip!="99" && ) %>%
  group_by(year) %>% mutate(year_total=sum(degrees)) %>% 
  group_by(year,CIPCODE,subcip,year_total) %>%
  summarize(degrees = sum(degrees))

field= "CIPCODE"
  
majors %>% 
  inner_join(cips) %>%
  group_by_("year","Type") %>% 
  summarize(degrees = sum(degrees), percent = sum(degrees)/year_total[1]) %>% 
  group_by(Type) %>% filter(sum(degrees) > 100) %>% 
  mutate(scaled = scale(percent)) %>% 
  ggplot() + aes(x=year,y=percent) + geom_line() + scale_y_continuous(labels=scales::percent,limits=c(0,.05)) + facet_wrap(~Type)


```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}


inst_array = data %>% 
  filter(year %in% c(2013,2014,2015,2007,2008,2009)) %>%
  mutate(year = year > 2010) %>%
  mutate(AWLEVEL=as.numeric(AWLEVEL),MAJORNUM=as.numeric(MAJORNUM)) %>% 
  filter(AWLEVEL==5,MAJORNUM==1) %>% 
  inner_join(characteristics %>% select(UNITID,INSTNM)) %>% inner_join(cips) %>%
  group_by(Type,General,INSTNM,UNITID,year) %>% 
  summarize(degrees=sum(degrees)) %>%
  group_by(UNITID) %>%
  filter(sum(degrees) > 1000) %>%
  group_by(INSTNM,year) %>% mutate(percent = degrees/sum(degrees))

inst_array %>% select(-degrees) %>% spread(year,percent,fill=0) %>% mutate(change = `TRUE` - `FALSE`) %>% filter(Type %in% c("History","English"),`FALSE` > 0) %>% ungroup %>% transmute(Type,INSTNM,`TRUE` = `TRUE`*100,change = change*100) %>% arrange(change) %>% group_by(INSTNM) %>% filter(n() == 2) %>% gather(variable,value,change,`TRUE`) %>% 
  unite(v,Type,variable) %>% spread(v,value) %>% ggplot() +
  geom_text() + aes(x=History_change,y=English_change,label=INSTNM) + lims(x=c(0,5),y=c(0,8))
  
  mutate(t1 = Type) %>% spread()



inst_grid = inst_array %>%
  filter(General %in% c("Humanities","Social Science")) %>% select(-General) %>%
  filter(Type != "General") %>%
  spread(Type,degrees,fill = 0)
  


model = lm(History ~ ., data = inst_grid[,3:ncol(inst_grid)])
summary(model)
data_frame(name = inst_grid$INSTNM, prediction = predict(model), actual = inst_grid$History) %>% 
arrange(-(actual-prediction))



```
